=================================================
E-ZUKA CONNECT ã‚µãƒ¼ãƒ“ã‚¹å†é–‹ãƒãƒ‹ãƒ¥ã‚¢ãƒ«
=================================================

æœ€çµ‚æ›´æ–°: 2025-10-17
ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚³ãƒ³ãƒ†ã‚¹ãƒˆçµ‚äº†æ™‚ç‚¹ã§ã®çŠ¶æ…‹ã‚’åŸºã«ä½œæˆ

=================================================
ç›®æ¬¡
=================================================
1. äº‹å‰æº–å‚™
2. GCPãƒªã‚½ãƒ¼ã‚¹ã®å†ä½œæˆ
3. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
4. ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒ‡ãƒ—ãƒ­ã‚¤
5. å‹•ä½œç¢ºèª
6. ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°
7. é‡è¦ãªè¨­å®šæƒ…å ±

=================================================
1. äº‹å‰æº–å‚™
=================================================

â–¡ å¿…è¦ãªãƒ„ãƒ¼ãƒ«ã®ç¢ºèª
  - gcloud CLI (Google Cloud SDK)
  - kubectl (Kubernetes CLI)
  - Docker
  - Git

â–¡ å¿…è¦ãªèªè¨¼æƒ…å ±ã®ç¢ºèª
  - GCPãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆID
  - GCPã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚­ãƒ¼
  - JWTç§˜å¯†éµ (JWT_SECRET_KEY)
  - ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰
  - LINE Messaging APIè¨­å®šï¼ˆå¿…è¦ã«å¿œã˜ã¦ï¼‰
    * Channel Secret
    * Channel Access Token

â–¡ ã‚³ãƒ¼ãƒ‰ãƒªãƒã‚¸ãƒˆãƒªã®å–å¾—
  git clone <repository-url>
  cd your-gcp-project-id
  git checkout main
  # ã¾ãŸã¯ç‰¹å®šã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³: git checkout v1.0-contest-end

=================================================
2. GCPãƒªã‚½ãƒ¼ã‚¹ã®å†ä½œæˆ
=================================================

2.1 GCPãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®è¨­å®š
-------------------------------------------------
# ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆIDã‚’è¨­å®š
export PROJECT_ID="your-project-id"
gcloud config set project $PROJECT_ID

# å¿…è¦ãªAPIã‚’æœ‰åŠ¹åŒ–
gcloud services enable container.googleapis.com
gcloud services enable sqladmin.googleapis.com
gcloud services enable storage-api.googleapis.com
gcloud services enable documentai.googleapis.com

2.2 GKEã‚¯ãƒ©ã‚¹ã‚¿ã®ä½œæˆ
-------------------------------------------------
# åŸºæœ¬çš„ãªã‚¯ãƒ©ã‚¹ã‚¿ä½œæˆï¼ˆãƒªãƒ¼ã‚¸ãƒ§ãƒ³ã¨ã‚¾ãƒ¼ãƒ³ã¯è¦ä»¶ã«å¿œã˜ã¦èª¿æ•´ï¼‰
gcloud container clusters create e-zuka-cluster \
  --zone asia-northeast1-a \
  --num-nodes 2 \
  --machine-type e2-medium \
  --disk-size 20 \
  --enable-autoscaling \
  --min-nodes 1 \
  --max-nodes 3

# ã‚¯ãƒ©ã‚¹ã‚¿èªè¨¼æƒ…å ±ã‚’å–å¾—
gcloud container clusters get-credentials e-zuka-cluster \
  --zone asia-northeast1-a

# ã‚¯ãƒ©ã‚¹ã‚¿æ¥ç¶šç¢ºèª
kubectl cluster-info
kubectl get nodes

2.3 Cloud SQLã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®ä½œæˆ
-------------------------------------------------
# PostgreSQLã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ä½œæˆï¼ˆæœ¬ç•ªç’°å¢ƒã®å ´åˆï¼‰
gcloud sql instances create e-zuka-postgres \
  --database-version=POSTGRES_15 \
  --tier=db-f1-micro \
  --region=asia-northeast1 \
  --root-password="YOUR_STRONG_PASSWORD"

# ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ä½œæˆ
gcloud sql databases create ezuka_db \
  --instance=e-zuka-postgres

# ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆ
gcloud sql users create ezuka_user \
  --instance=e-zuka-postgres \
  --password="YOUR_USER_PASSWORD"

# Cloud SQL Proxyã‚’ä½¿ç”¨ã™ã‚‹å ´åˆã®ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆè¨­å®š
gcloud iam service-accounts create cloudsql-proxy
gcloud projects add-iam-policy-binding $PROJECT_ID \
  --member="serviceAccount:cloudsql-proxy@$PROJECT_ID.iam.gserviceaccount.com" \
  --role="roles/cloudsql.client"

# æ¥ç¶šåã‚’ç¢ºèªï¼ˆå¾Œã§ä½¿ç”¨ï¼‰
gcloud sql instances describe e-zuka-postgres --format="value(connectionName)"

2.4 Cloud Storageãƒã‚±ãƒƒãƒˆã®ä½œæˆ
-------------------------------------------------
# ãƒ¬ã‚·ãƒ¼ãƒˆç”»åƒä¿å­˜ç”¨ãƒã‚±ãƒƒãƒˆ
gsutil mb -l asia-northeast1 gs://$PROJECT_ID-receipts/
gsutil mb -l asia-northeast1 gs://$PROJECT_ID-receipts-processed/

# ãƒã‚±ãƒƒãƒˆã¸ã®ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™è¨­å®š
gsutil iam ch serviceAccount:YOUR_SERVICE_ACCOUNT@$PROJECT_ID.iam.gserviceaccount.com:objectAdmin \
  gs://$PROJECT_ID-receipts/

2.5 Document AI Processorã®è¨­å®š
-------------------------------------------------
# Document AI APIãŒæœ‰åŠ¹ã«ãªã£ã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèª
gcloud services enable documentai.googleapis.com

# Processorã‚’ä½œæˆï¼ˆGCPã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§å®Ÿè¡Œã™ã‚‹ã“ã¨ã‚’æ¨å¥¨ï¼‰
# 1. GCPã‚³ãƒ³ã‚½ãƒ¼ãƒ« > Document AI > Processors
# 2. "CREATE PROCESSOR"ã‚’ã‚¯ãƒªãƒƒã‚¯
# 3. "Form Parser" ã¾ãŸã¯ "OCR Processor"ã‚’é¸æŠ
# 4. Processor IDã‚’ãƒ¡ãƒ¢ï¼ˆç’°å¢ƒå¤‰æ•°ã§ä½¿ç”¨ï¼‰

=================================================
3. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
=================================================

3.1 ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¹ã‚­ãƒ¼ãƒã®ä½œæˆ
-------------------------------------------------
# æ–¹æ³•1: SQLAlchemyãƒ¢ãƒ‡ãƒ«ã‹ã‚‰è‡ªå‹•ä½œæˆ
cd services/core-api

# ç’°å¢ƒå¤‰æ•°ã‚’è¨­å®š
export DATABASE_URL="postgresql://ezuka_user:YOUR_PASSWORD@CLOUD_SQL_IP:5432/ezuka_db"

# Pythonã§å®Ÿè¡Œ
python -c "from app.database import engine; from app.models import Base; Base.metadata.create_all(bind=engine)"

# æ–¹æ³•2: Alembicãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ä½¿ç”¨
alembic upgrade head

# æ–¹æ³•3: SQLãƒ€ãƒ³ãƒ—ã‹ã‚‰å¾©å…ƒï¼ˆãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãŒã‚ã‚‹å ´åˆï¼‰
psql -h CLOUD_SQL_IP -U ezuka_user -d ezuka_db -f schema-backup.sql

3.2 åˆæœŸãƒ‡ãƒ¼ã‚¿ã®æŠ•å…¥
-------------------------------------------------
# åˆæœŸãƒãƒƒã‚¸ãƒ‡ãƒ¼ã‚¿ãªã©ã€å¿…è¦ã«å¿œã˜ã¦æŠ•å…¥
# services/core-api/scripts/ é…ä¸‹ã«ã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒã‚ã‚‹å ´åˆ
python scripts/init_badges.py

3.3 Kubernetes Secretã®ä½œæˆ
-------------------------------------------------
# ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šæƒ…å ±ã‚’Secretã¨ã—ã¦ä¿å­˜
kubectl create secret generic db-secret \
  --from-literal=DATABASE_URL="postgresql://ezuka_user:YOUR_PASSWORD@CLOUD_SQL_IP:5432/ezuka_db"

# JWTç§˜å¯†éµ
kubectl create secret generic jwt-secret \
  --from-literal=JWT_SECRET_KEY="your-random-secret-key-here"

# GCPã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚­ãƒ¼
kubectl create secret generic gcp-credentials \
  --from-file=key.json=/path/to/service-account-key.json

# LINE APIè¨­å®šï¼ˆå¿…è¦ã«å¿œã˜ã¦ï¼‰
kubectl create secret generic line-secret \
  --from-literal=LINE_CHANNEL_SECRET="your-channel-secret" \
  --from-literal=LINE_CHANNEL_ACCESS_TOKEN="your-access-token"

=================================================
4. ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒ‡ãƒ—ãƒ­ã‚¤
=================================================

4.1 Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã®ãƒ“ãƒ«ãƒ‰ã¨ãƒ—ãƒƒã‚·ãƒ¥
-------------------------------------------------
# GCR (Google Container Registry) ã‚’ä½¿ç”¨ã™ã‚‹å ´åˆ
export PROJECT_ID="your-project-id"

# Core API
cd services/core-api
docker build -t gcr.io/$PROJECT_ID/core-api:v1.0 .
docker push gcr.io/$PROJECT_ID/core-api:v1.0

# OCR Processor
cd ../ocr-processor
docker build -t gcr.io/$PROJECT_ID/ocr-processor:v1.0 .
docker push gcr.io/$PROJECT_ID/ocr-processor:v1.0

# Frontend
cd ../../frontend
docker build -t gcr.io/$PROJECT_ID/frontend:v1.0 .
docker push gcr.io/$PROJECT_ID/frontend:v1.0

4.2 Kubernetes ConfigMapã®ä½œæˆ
-------------------------------------------------
# ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³è¨­å®š
kubectl create configmap app-config \
  --from-literal=ENVIRONMENT="production" \
  --from-literal=PROJECT_ID="$PROJECT_ID" \
  --from-literal=PROCESSOR_ID="your-processor-id" \
  --from-literal=GCS_BUCKET_NAME="$PROJECT_ID-receipts"

4.3 Kubernetesãƒªã‚½ãƒ¼ã‚¹ã®ãƒ‡ãƒ—ãƒ­ã‚¤
-------------------------------------------------
# kubernetes/base/ ã¨ kubernetes/production/ ã®è¨­å®šã‚’ç¢ºèª
# å¿…è¦ã«å¿œã˜ã¦ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚¿ã‚°ã‚„ãƒ¬ãƒ—ãƒªã‚«æ•°ã‚’èª¿æ•´

# kustomizeã‚’ä½¿ç”¨ã—ã¦ãƒ‡ãƒ—ãƒ­ã‚¤
kubectl apply -k kubernetes/production/

# ã¾ãŸã¯å€‹åˆ¥ã«ãƒ‡ãƒ—ãƒ­ã‚¤
kubectl apply -f kubernetes/base/core-api-deployment.yaml
kubectl apply -f kubernetes/base/core-api-service.yaml
kubectl apply -f kubernetes/base/ocr-processor-deployment.yaml
kubectl apply -f kubernetes/base/ocr-processor-service.yaml
kubectl apply -f kubernetes/base/frontend-deployment.yaml
kubectl apply -f kubernetes/base/frontend-service.yaml

# Ingressã®è¨­å®šï¼ˆå¤–éƒ¨ã‚¢ã‚¯ã‚»ã‚¹ç”¨ï¼‰
kubectl apply -f kubernetes/base/ingress.yaml

4.4 CronJobã®ãƒ‡ãƒ—ãƒ­ã‚¤ï¼ˆãƒ—ãƒ­ãƒ¢ãƒ¼ã‚·ãƒ§ãƒ³è‡ªå‹•æ²è¼‰ãªã©ï¼‰
-------------------------------------------------
kubectl apply -f kubernetes/base/promotion-cronjob.yaml

# CronJobã®å‹•ä½œç¢ºèª
kubectl get cronjobs

=================================================
5. å‹•ä½œç¢ºèª
=================================================

5.1 Podã®çŠ¶æ…‹ç¢ºèª
-------------------------------------------------
kubectl get pods
kubectl get services
kubectl get ingress

# å„Podã®ãƒ­ã‚°ç¢ºèª
kubectl logs -l app=core-api
kubectl logs -l app=ocr-processor
kubectl logs -l app=frontend

5.2 ã‚µãƒ¼ãƒ“ã‚¹ã®ç–é€šç¢ºèª
-------------------------------------------------
# Core APIã®ç¢ºèª
kubectl port-forward svc/core-api 8000:8000
curl http://localhost:8000/api/debug/health

# OCR Processorã®ç¢ºèª
kubectl port-forward svc/ocr-processor 8001:8001
curl http://localhost:8001/health

# Frontendã®ç¢ºèª
kubectl port-forward svc/frontend 3000:3000
# ãƒ–ãƒ©ã‚¦ã‚¶ã§ http://localhost:3000 ã«ã‚¢ã‚¯ã‚»ã‚¹

5.3 ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šç¢ºèª
-------------------------------------------------
# Postgresã«ç›´æ¥æ¥ç¶š
kubectl port-forward svc/postgres 5432:5432
psql -h localhost -U ezuka_user -d ezuka_db

# ãƒ†ãƒ¼ãƒ–ãƒ«ä¸€è¦§è¡¨ç¤º
\dt

# ãƒ†ãƒ¼ãƒ–ãƒ«æ§‹é€ ç¢ºèª
\d users
\d receipts
\d stores

5.4 å¤–éƒ¨ã‚¢ã‚¯ã‚»ã‚¹ã®ç¢ºèª
-------------------------------------------------
# Ingressã®å¤–éƒ¨IPã‚’å–å¾—
kubectl get ingress

# å–å¾—ã—ãŸIPã¾ãŸã¯ãƒ‰ãƒ¡ã‚¤ãƒ³ã§ã‚¢ã‚¯ã‚»ã‚¹ãƒ†ã‚¹ãƒˆ
curl http://YOUR_DOMAIN/api/debug/health

=================================================
6. ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°
=================================================

6.1 ã‚ˆãã‚ã‚‹å•é¡Œã¨è§£æ±ºæ–¹æ³•
-------------------------------------------------

å•é¡Œ: PodãŒèµ·å‹•ã—ãªã„ (ImagePullBackOff)
è§£æ±º:
  - ã‚¤ãƒ¡ãƒ¼ã‚¸åãŒæ­£ã—ã„ã‹ç¢ºèª
  - GCRã¸ã®ãƒ—ãƒƒã‚·ãƒ¥ãŒå®Œäº†ã—ã¦ã„ã‚‹ã‹ç¢ºèª
  - GKEã‚¯ãƒ©ã‚¹ã‚¿ãŒGCRã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ã‹ç¢ºèª
  kubectl describe pod <pod-name>

å•é¡Œ: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«æ¥ç¶šã§ããªã„
è§£æ±º:
  - DATABASE_URLç’°å¢ƒå¤‰æ•°ãŒæ­£ã—ã„ã‹ç¢ºèª
  - Cloud SQL ProxyãŒå‹•ä½œã—ã¦ã„ã‚‹ã‹ç¢ºèª
  - ãƒ•ã‚¡ã‚¤ã‚¢ã‚¦ã‚©ãƒ¼ãƒ«ãƒ«ãƒ¼ãƒ«ã‚’ç¢ºèª
  kubectl logs <pod-name>

å•é¡Œ: OCRå‡¦ç†ãŒå¤±æ•—ã™ã‚‹
è§£æ±º:
  - Document AI Processor IDãŒæ­£ã—ã„ã‹ç¢ºèª
  - GCPã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã«å¿…è¦ãªæ¨©é™ãŒã‚ã‚‹ã‹ç¢ºèª
  - GCS URIãŒæ­£ã—ã„ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã‹ç¢ºèª
  kubectl logs -l app=ocr-processor

å•é¡Œ: CORSã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã™ã‚‹
è§£æ±º:
  - core-apiã®CORSè¨­å®šã‚’ç¢ºèª
  - services/core-api/app/main.py ã® origins ãƒªã‚¹ãƒˆã«
    ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®URLãŒå«ã¾ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª

å•é¡Œ: SecretsãŒè¦‹ã¤ã‹ã‚‰ãªã„
è§£æ±º:
  kubectl get secrets
  kubectl describe secret <secret-name>

6.2 ãƒ­ã‚°ã®ç¢ºèªæ–¹æ³•
-------------------------------------------------
# ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ­ã‚°
kubectl logs -f <pod-name>

# å‰å›ã®ã‚³ãƒ³ãƒ†ãƒŠãƒ­ã‚°ï¼ˆå†èµ·å‹•ã—ãŸå ´åˆï¼‰
kubectl logs <pod-name> --previous

# å…¨ã¦ã®Podã®ãƒ­ã‚°ã‚’ä¸€æ‹¬ç¢ºèª
kubectl logs -l app=core-api --tail=100

6.3 ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰ã§ã®èµ·å‹•
-------------------------------------------------
# Core APIã‚’ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰ã§èµ·å‹•
kubectl exec -it <core-api-pod-name> -- /bin/bash
cd /app
uvicorn app.main:app --reload --host 0.0.0.0 --port 8000 --log-level debug

=================================================
7. é‡è¦ãªè¨­å®šæƒ…å ±
=================================================

7.1 ãƒ†ãƒ¼ãƒ–ãƒ«æ§‹é€ ã®å ´æ‰€
-------------------------------------------------
- ãƒ¢ãƒ‡ãƒ«å®šç¾©: services/core-api/app/models.py
- ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³: services/core-api/alembic/versions/
- ã‚¹ã‚­ãƒ¼ãƒæƒ…å ±: ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚Œã°å†ä½œæˆå¯èƒ½

7.2 ä¸»è¦ãªãƒ†ãƒ¼ãƒ–ãƒ«ä¸€è¦§
-------------------------------------------------
ãƒ¦ãƒ¼ã‚¶ãƒ¼ç³»:
  - users: ãƒ¦ãƒ¼ã‚¶ãƒ¼åŸºæœ¬æƒ…å ±
  - gamification_profiles: ã‚²ãƒ¼ãƒŸãƒ•ã‚£ã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«
  - badges, user_badges: ãƒãƒƒã‚¸ã‚·ã‚¹ãƒ†ãƒ 
  - point_transactions: ãƒã‚¤ãƒ³ãƒˆå±¥æ­´
  - line_integrations: LINEé€£æºæƒ…å ±

äº‹æ¥­è€…ç³»:
  - stores: åº—èˆ—æƒ…å ±
  - store_owners: åº—èˆ—ã‚ªãƒ¼ãƒŠãƒ¼
  - products: å•†å“ãƒã‚¹ã‚¿
  - product_categories: å•†å“ã‚«ãƒ†ã‚´ãƒª
  - promotions: ãƒ—ãƒ­ãƒ¢ãƒ¼ã‚·ãƒ§ãƒ³æƒ…å ±
  - events: ã‚¤ãƒ™ãƒ³ãƒˆæƒ…å ±
  - archive_contents: ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã‚³ãƒ³ãƒ†ãƒ³ãƒ„

å–å¼•ç³»:
  - receipts: ãƒ¬ã‚·ãƒ¼ãƒˆæƒ…å ±
  - receipt_items: ãƒ¬ã‚·ãƒ¼ãƒˆæ˜ç´°
  - rewards: ç‰¹å…¸ãƒã‚¹ã‚¿
  - user_rewards: ãƒ¦ãƒ¼ã‚¶ãƒ¼å–å¾—ç‰¹å…¸

æ°—è±¡ãƒ‡ãƒ¼ã‚¿ç³»:
  - weather_data: å¤©æ°—ãƒ‡ãƒ¼ã‚¿
  - historical_weather_data: éå»æ°—è±¡ãƒ‡ãƒ¼ã‚¿

7.3 ç’°å¢ƒå¤‰æ•°ä¸€è¦§
-------------------------------------------------
# Core API
DATABASE_URL: PostgreSQLæ¥ç¶šURL
JWT_SECRET_KEY: JWTç½²åç”¨ç§˜å¯†éµ
JWT_ALGORITHM: HS256
ACCESS_TOKEN_EXPIRE_MINUTES: 30
PROJECT_ID: GCPãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆID
PROCESSOR_ID: Document AI Processor ID
GCS_BUCKET_NAME: ãƒ¬ã‚·ãƒ¼ãƒˆä¿å­˜ç”¨ãƒã‚±ãƒƒãƒˆå
LINE_CHANNEL_SECRET: LINE Channel Secret
LINE_CHANNEL_ACCESS_TOKEN: LINE Channel Access Token
CORS_ORIGINS: è¨±å¯ã™ã‚‹ã‚ªãƒªã‚¸ãƒ³ï¼ˆã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šï¼‰

# OCR Processor
PROJECT_ID: GCPãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆID
PROCESSOR_ID: Document AI Processor ID
LOCATION: Processorã®ãƒ­ã‚±ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆus, euç­‰ï¼‰

# Frontend
NEXT_PUBLIC_API_URL: ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰APIã®URL

7.4 ãƒãƒ¼ãƒˆç•ªå·
-------------------------------------------------
- Frontend: 3000
- Core API: 8000
- OCR Processor: 8001
- PostgreSQL: 5432

7.5 ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ 
-------------------------------------------------
your-gcp-project-id/
â”œâ”€â”€ frontend/                 # Next.js ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰
â”‚   â”œâ”€â”€ app/                 # Next.js App Router
â”‚   â”œâ”€â”€ components/          # Reactã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
â”‚   â””â”€â”€ public/              # é™çš„ãƒ•ã‚¡ã‚¤ãƒ«
â”œâ”€â”€ services/
â”‚   â”œâ”€â”€ core-api/            # ãƒ¡ã‚¤ãƒ³APIã‚µãƒ¼ãƒ“ã‚¹
â”‚   â”‚   â”œâ”€â”€ app/
â”‚   â”‚   â”‚   â”œâ”€â”€ models.py   # â˜…ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ¢ãƒ‡ãƒ«å®šç¾©
â”‚   â”‚   â”‚   â”œâ”€â”€ schemas.py  # Pydanticã‚¹ã‚­ãƒ¼ãƒ
â”‚   â”‚   â”‚   â”œâ”€â”€ crud.py     # DBæ“ä½œ
â”‚   â”‚   â”‚   â””â”€â”€ routers/    # APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ
â”‚   â”‚   â””â”€â”€ alembic/         # â˜…DBãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
â”‚   â””â”€â”€ ocr-processor/       # OCRã‚µãƒ¼ãƒ“ã‚¹
â””â”€â”€ kubernetes/              # K8sè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«
    â”œâ”€â”€ base/
    â””â”€â”€ production/

7.6 API ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆä¸€è¦§
-------------------------------------------------
èªè¨¼:
  POST /api/auth/register      # ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²
  POST /api/auth/login         # ãƒ­ã‚°ã‚¤ãƒ³
  POST /api/auth/owner/register # äº‹æ¥­è€…ç™»éŒ²
  POST /api/auth/owner/login   # äº‹æ¥­è€…ãƒ­ã‚°ã‚¤ãƒ³

ãƒ¦ãƒ¼ã‚¶ãƒ¼:
  GET  /api/users/me           # è‡ªåˆ†ã®æƒ…å ±å–å¾—
  PUT  /api/users/me           # è‡ªåˆ†ã®æƒ…å ±æ›´æ–°

ãƒ¬ã‚·ãƒ¼ãƒˆ:
  GET  /api/receipts           # ãƒ¬ã‚·ãƒ¼ãƒˆä¸€è¦§
  POST /api/receipts           # ãƒ¬ã‚·ãƒ¼ãƒˆç™»éŒ²
  GET  /api/receipts/{id}      # ãƒ¬ã‚·ãƒ¼ãƒˆè©³ç´°

ã‚²ãƒ¼ãƒŸãƒ•ã‚£ã‚±ãƒ¼ã‚·ãƒ§ãƒ³:
  GET  /api/gamification/profile    # ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«å–å¾—
  GET  /api/gamification/badges     # ãƒãƒƒã‚¸ä¸€è¦§
  GET  /api/gamification/transactions # ãƒã‚¤ãƒ³ãƒˆå±¥æ­´

ãƒ—ãƒ­ãƒ¢ãƒ¼ã‚·ãƒ§ãƒ³:
  GET  /api/promotions              # ãƒ—ãƒ­ãƒ¢ãƒ¼ã‚·ãƒ§ãƒ³ä¸€è¦§
  POST /api/promotions              # ãƒ—ãƒ­ãƒ¢ãƒ¼ã‚·ãƒ§ãƒ³ä½œæˆ
  PUT  /api/promotions/{id}         # ãƒ—ãƒ­ãƒ¢ãƒ¼ã‚·ãƒ§ãƒ³æ›´æ–°

å•†å“:
  GET  /api/products                # å•†å“ä¸€è¦§
  POST /api/products                # å•†å“ç™»éŒ²

åº—èˆ—:
  GET  /api/stores                  # åº—èˆ—ä¸€è¦§
  POST /api/stores                  # åº—èˆ—ç™»éŒ²

å¤©æ°—:
  GET  /api/weather/current         # ç¾åœ¨ã®å¤©æ°—
  GET  /api/weather/forecast        # å¤©æ°—äºˆå ±
  GET  /api/historical-weather      # éå»æ°—è±¡ãƒ‡ãƒ¼ã‚¿

ãƒ‡ãƒãƒƒã‚°:
  GET  /api/debug/health            # ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯
  GET  /api/debug/db                # DBæ¥ç¶šç¢ºèª

=================================================
8. ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°ã¨ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–
=================================================

8.1 æ°´å¹³ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°
-------------------------------------------------
# Deploymentã®ãƒ¬ãƒ—ãƒªã‚«æ•°ã‚’å¢—ã‚„ã™
kubectl scale deployment core-api --replicas=3
kubectl scale deployment frontend --replicas=2

# HPA (Horizontal Pod Autoscaler) ã®è¨­å®š
kubectl autoscale deployment core-api \
  --cpu-percent=70 \
  --min=2 \
  --max=5

8.2 ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æœ€é©åŒ–
-------------------------------------------------
- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®ç¢ºèªã¨ä½œæˆ
- æ¥ç¶šãƒ—ãƒ¼ãƒ«ã®è¨­å®šèª¿æ•´
- Cloud SQLã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚¿ã‚¤ãƒ—ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰

8.3 ã‚­ãƒ£ãƒƒã‚·ãƒ³ã‚°
-------------------------------------------------
- Redisã®å°å…¥æ¤œè¨
- CloudCDNã®æ´»ç”¨

=================================================
9. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è€ƒæ…®äº‹é …
=================================================

â–¡ Secretsã®ç®¡ç†
  - Kubernetes Secretsã‚’ä½¿ç”¨
  - Google Secret Managerã®æ¤œè¨

â–¡ ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ãƒãƒªã‚·ãƒ¼
  - NetworkPolicyã®è¨­å®š
  - Podé–“é€šä¿¡ã®åˆ¶é™

â–¡ èªè¨¼ãƒ»èªå¯
  - JWT ãƒˆãƒ¼ã‚¯ãƒ³ã®æœ‰åŠ¹æœŸé™è¨­å®š
  - ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒãƒªã‚·ãƒ¼ã®ç¢ºèª

â–¡ HTTPS/TLS
  - Ingressã§ã®TLSçµ‚ç«¯
  - Let's Encryptã®è¨¼æ˜æ›¸å–å¾—

=================================================
10. ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã¨ãƒªã‚«ãƒãƒª
=================================================

10.1 å®šæœŸãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã®è¨­å®š
-------------------------------------------------
# Cloud SQLã®è‡ªå‹•ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—æœ‰åŠ¹åŒ–
gcloud sql instances patch e-zuka-postgres \
  --backup-start-time=03:00

# GCSãƒã‚±ãƒƒãƒˆã®ãƒãƒ¼ã‚¸ãƒ§ãƒ‹ãƒ³ã‚°æœ‰åŠ¹åŒ–
gsutil versioning set on gs://$PROJECT_ID-receipts/

10.2 ãƒªã‚¹ãƒˆã‚¢æ‰‹é †
-------------------------------------------------
# Cloud SQLã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‹ã‚‰ãƒªã‚¹ãƒˆã‚¢
gcloud sql backups list --instance=e-zuka-postgres
gcloud sql backups restore <BACKUP_ID> \
  --backup-instance=e-zuka-postgres

=================================================
11. ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°ã¨ã‚¢ãƒ©ãƒ¼ãƒˆ
=================================================

11.1 ãƒ­ã‚°ã®ç¢ºèª
-------------------------------------------------
# GCP Loggingã§ãƒ­ã‚°ã‚’ç¢ºèª
gcloud logging read "resource.type=k8s_container"

11.2 ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã®ç›£è¦–
-------------------------------------------------
# Cloud Monitoringãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ä½œæˆ
# - CPUä½¿ç”¨ç‡
# - ãƒ¡ãƒ¢ãƒªä½¿ç”¨ç‡
# - ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ•°
# - ã‚¨ãƒ©ãƒ¼ç‡
# - ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·

=================================================
12. ã‚³ã‚¹ãƒˆæœ€é©åŒ–
=================================================

â–¡ é–‹ç™ºç’°å¢ƒã¨æœ¬ç•ªç’°å¢ƒã®åˆ†é›¢
â–¡ ä½¿ç”¨ã—ã¦ã„ãªã„ãƒªã‚½ãƒ¼ã‚¹ã®å‰Šé™¤
â–¡ Cloud SQLã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚µã‚¤ã‚ºã®æœ€é©åŒ–
â–¡ GKEãƒãƒ¼ãƒ‰ã®ãƒ—ãƒªã‚¨ãƒ³ãƒ—ãƒ†ã‚£ãƒ–ãƒ«VMã®æ¤œè¨
â–¡ GCSã®ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«ãƒãƒªã‚·ãƒ¼è¨­å®š

=================================================
ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ: ã‚µãƒ¼ãƒ“ã‚¹å†é–‹æ™‚
=================================================

äº‹å‰æº–å‚™:
â–¡ GCPãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ä½œæˆãƒ»è¨­å®š
â–¡ å¿…è¦ãªèªè¨¼æƒ…å ±ã®æº–å‚™
â–¡ ã‚³ãƒ¼ãƒ‰ãƒªãƒã‚¸ãƒˆãƒªã®ã‚¯ãƒ­ãƒ¼ãƒ³

GCPãƒªã‚½ãƒ¼ã‚¹:
â–¡ GKEã‚¯ãƒ©ã‚¹ã‚¿ã®ä½œæˆ
â–¡ Cloud SQLã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®ä½œæˆ
â–¡ Cloud Storageãƒã‚±ãƒƒãƒˆã®ä½œæˆ
â–¡ Document AI Processorã®è¨­å®š
â–¡ å¿…è¦ãªAPIã®æœ‰åŠ¹åŒ–

ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹:
â–¡ ã‚¹ã‚­ãƒ¼ãƒã®ä½œæˆï¼ˆmodels.pyã‹ã‚‰ï¼‰
â–¡ åˆæœŸãƒ‡ãƒ¼ã‚¿ã®æŠ•å…¥
â–¡ Kubernetes Secretsã®ä½œæˆ

ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³:
â–¡ Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã®ãƒ“ãƒ«ãƒ‰
â–¡ GCRã¸ã®ãƒ—ãƒƒã‚·ãƒ¥
â–¡ ConfigMapã®ä½œæˆ
â–¡ Deploymentã®ãƒ‡ãƒ—ãƒ­ã‚¤
â–¡ Serviceã®ãƒ‡ãƒ—ãƒ­ã‚¤
â–¡ Ingressã®è¨­å®š

å‹•ä½œç¢ºèª:
â–¡ Podã®èµ·å‹•ç¢ºèª
â–¡ ã‚µãƒ¼ãƒ“ã‚¹ã®ç–é€šç¢ºèª
â–¡ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šç¢ºèª
â–¡ å¤–éƒ¨ã‚¢ã‚¯ã‚»ã‚¹ã®ç¢ºèª
â–¡ APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã®ãƒ†ã‚¹ãƒˆ
â–¡ ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®å‹•ä½œç¢ºèª

æœ¬ç•ªç’°å¢ƒè¨­å®š:
â–¡ ãƒ‰ãƒ¡ã‚¤ãƒ³ã®è¨­å®š
â–¡ TLSè¨¼æ˜æ›¸ã®è¨­å®š
â–¡ ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°ã®è¨­å®š
â–¡ ã‚¢ãƒ©ãƒ¼ãƒˆã®è¨­å®š
â–¡ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã®è¨­å®š

=================================================
å‚è€ƒè³‡æ–™ã¨ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ
=================================================

- CLAUDE.md: é–‹ç™ºã‚³ãƒãƒ³ãƒ‰ã¨ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£æ¦‚è¦
- services/core-api/app/models.py: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¹ã‚­ãƒ¼ãƒå®šç¾©
- kubernetes/: Kubernetesè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«
- å¤‰æ›´å±¥æ­´ãƒ•ã‚¡ã‚¤ãƒ«: 2025-XX-XX-changes.txt

=================================================
ã‚µãƒãƒ¼ãƒˆé€£çµ¡å…ˆ
=================================================

æŠ€è¡“çš„ãªå•é¡ŒãŒç™ºç”Ÿã—ãŸå ´åˆ:
1. ã“ã®ãƒãƒ‹ãƒ¥ã‚¢ãƒ«ã®ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’ç¢ºèª
2. Podã®ãƒ­ã‚°ã‚’ç¢ºèª
3. GCPã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§ãƒªã‚½ãƒ¼ã‚¹ã®çŠ¶æ…‹ã‚’ç¢ºèª

=================================================
æœ€å¾Œã«
=================================================

ã“ã®ãƒãƒ‹ãƒ¥ã‚¢ãƒ«ã«å¾“ãˆã°ã€GKEã‚¯ãƒ©ã‚¹ã‚¿ã€Cloud SQLã€Cloud Storageã‚’
å‰Šé™¤ã—ãŸå¾Œã§ã‚‚ã€åŒã˜æ§‹é€ ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å†æ§‹ç¯‰ã§ãã¾ã™ã€‚

é‡è¦ãªã®ã¯:
1. ã‚³ãƒ¼ãƒ‰ãƒªãƒã‚¸ãƒˆãƒªï¼ˆç‰¹ã«models.pyï¼‰ã‚’ä¿æŒã™ã‚‹ã“ã¨
2. ç’°å¢ƒå¤‰æ•°ã¨èªè¨¼æƒ…å ±ã‚’è¨˜éŒ²ã—ã¦ãŠãã“ã¨
3. GCPãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆIDã‚„Processor IDãªã©ã®è¨­å®šå€¤ã‚’ä¿å­˜ã—ã¦ãŠãã“ã¨

ãƒ‡ãƒ¼ã‚¿ã¯å¤±ã‚ã‚Œã¾ã™ãŒã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®æ§‹é€ ã¨æ©Ÿèƒ½ã¯
å®Œå…¨ã«å¾©å…ƒå¯èƒ½ã§ã™ã€‚

Good luck with the service recovery! ğŸš€
