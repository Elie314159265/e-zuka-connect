# 2025-07-10 進捗サマリ & 再開手順

## 本日の進捗サマリ

### 達成状況
- **インフラ**: GKE Autopilotクラスタ (`study`) 上に、基本的なインフラを構築した。
- **サービス**: `frontend`, `core-api`, `ocr-processor` の3つのサービスを定義し、Podがすべて `Running` 状態で正常に稼働している。
- **コンテナイメージ**: 全サービスのコンテナイメージをビルドし、GCP Artifact Registry (`your-gcp-project-id-repo`) にプッシュ済み。
- **IPとドメイン**: 静的IP (`34.149.22.160`) を予約し、Ingressに正しく関連付けた。ドメイン `your-gcp-project-id.com` と `www.your-gcp-project-id.com` のDNS AレコードもこのIPに設定済み。
- **HTTPアクセス**: `http://your-gcp-project-id.com` でフロントエンドの初期画面にアクセスできることを確認済み。

### 未完了・保留中のタスク
- **HTTPSアクセス**: GoogleマネージドSSL証明書がまだ `Provisioning`（プロビジョニング中）の状態。このため、`https://your-gcp-project-id.com` にはまだアクセスできない。DNSの伝播が完了し、証明書が `Active` になるのを待つ必要がある。

### 主なトラブルシューティング履歴
1.  **`kubectl` 接続エラー**: `gcloud container clusters get-credentials` を実行して解決。
2.  **バックエンドPodの `CrashLoopBackOff`**: `requirements.txt` が空だったため、`fastapi` と `uvicorn` を追記してイメージを再ビルドし解決。
3.  **IngressのIPが払い出されない**: Ingressマニフェストで指定した静적IPのリソース名が誤っていたため、正しい名前 (`iizuka-connect-static-ip`) に修正して解決。
4.  **404 (backend NotFound) エラー**: Ingressの `pathType` が曖昧だったため、`ImplementationSpecific` から `Prefix` に変更して解決。

---

## 次回再開時のクラスタ再作成手順

**前提**:
- `gcloud`, `kubectl`, `docker` コマンドが利用可能。
- カレントディレクトリはプロジェクトのルート (`/home/souxiasatoru/your-gcp-project-id`)。
- **永続リソース**: 静的IP (`iizuka-connect-static-ip`) と Artifact Registryリポジトリ (`your-gcp-project-id-repo`) は削除されていない。

---

### 手順1: GKEクラスタの再作成
GKE Autopilotクラスタを同じ名前と設定で再作成します。

```bash
gcloud container clusters create-auto study \
    --region=asia-northeast1 \
    --project=your-gcp-project-id
```

### 手順2: `kubectl` の認証情報取得
新しく作成したクラスタに `kubectl` が接続できるように、認証情報を取得します。

```bash
gcloud container clusters get-credentials study \
    --region=asia-northeast1 \
    --project=your-gcp-project-id
```

### 手順3: Dockerの認証設定
ローカルのDockerがArtifact Registryにアクセスできるように認証を設定します。（新しい環境で作業する場合に必要）

```bash
gcloud auth configure-docker asia-northeast1-docker.pkg.dev \
    --project=your-gcp-project-id
```

### 手順4: すべてのリソースをデプロイ
ローカルのマニフェストをすべてクラスタに適用します。イメージはArtifact Registryからプルされるため、再ビルドは不要です。

```bash
kubectl apply -k kubernetes/base
```

### 手順5: 状態の確認と待機
デプロイ後、各コンポーネントが準備完了になるまで待機します。

1.  **Podの確認**: すべてのPodが `Running` になることを確認します。
    ```bash
    kubectl get pods -n your-gcp-project-id -w
    ```
2.  **Ingressの確認**: ロードバランサがプロビジョニングされ、IPアドレスが割り当てられるまで数分待ちます。
    ```bash
    # ADDRESS列にIPが表示されるまで数分待つ
    kubectl get ingress -n your-gcp-project-id
    ```
3.  **SSL証明書の確認**: 証明書のステータスが `Provisioning` から `Active` に変わるまで待ちます。これには最も時間がかかります（数十分〜数時間）。
    ```bash
    # Status が Active になるまで待つ
    kubectl describe managedcertificate your-gcp-project-id-certificate -n your-gcp-project-id
    ```

上記の手順で、本日の作業終了時点の状態を復元できます.
---

## Kubernetesリソースの完全削除手順

現在動作しているすべてのKubernetesリソースを削除するには、以下のコマンドを実行します。
これにより、`kustomize` で管理されているすべてのデプロイメント、サービス、Ingressなどが削除されます。

```bash
kubectl delete -k kubernetes/overlays/production
```