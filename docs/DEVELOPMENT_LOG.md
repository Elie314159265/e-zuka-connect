# E-Zuka Connect 開発ログ

このドキュメントは、プロジェクトの主要な開発マイルストーンと変更履歴を記録しています。

## 主要マイルストーン

### 2025-07-10: プロジェクト開始

- プロジェクト設計
- 技術スタック選定
- GCPプロジェクト設定

### 2025-07-12: 基礎機能実装

- **OCR処理**: Google Document AI統合
- **天候データ**: Open-Meteo API統合
- **データ分析**: 基本的な分析機能実装

### 2025-07-17: セキュリティ脆弱性評価

- セキュリティ監査実施
- 脆弱性の特定と対策計画策定

### 2025-07-18: セキュリティ強化実装

#### 実装した機能

1. **JWT リフレッシュトークンシステム**
   - Access Token: 15分
   - Refresh Token: 30日
   - トークン分離によるセキュリティ向上

2. **API レート制限**
   - 認証エンドポイント: 5回/分
   - 一般API: 60回/分
   - DDoS攻撃防御

3. **構造化ログシステム**
   - JSON形式のログ
   - セキュリティイベント追跡
   - ビジネスメトリクス記録

4. **パスワード強度要件**
   - 最小8文字
   - 大文字・小文字・数字・特殊文字必須
   - 強度スコア計算

#### ゲーミフィケーション要件定義

- ポイントシステム設計
- バッジシステム設計
- レベルシステム設計

### 2025-09-27: データベース移行

- PostgreSQLスキーマ設計
- 初期データ投入
- ゲーミフィケーション機能実装

### 2025-09-29: bcrypt互換性問題修正

- bcrypt 5.0.0 → 4.0.1へダウングレード
- JWT秘密鍵の強化（ランダム値へ変更）
- セキュリティ監査実施

### 2025-09-30: 大規模機能拡張（4フェーズ実装）

#### Phase 1: レシート店舗マッチング機能
- **OCR精度向上**: 電話番号による店舗識別機能追加
- **自動店舗管理**: レシートアップロード時に店舗を自動作成
- **店舗検索ロジック**:
  1. 電話番号の正規化一致（最優先）
  2. 店名の部分一致
  3. 新規店舗作成（見つからない場合）

#### Phase 2: 売上分析グラフ改善
- **データソース統合**:
  - 過去7日間: `historical_weather_data`（実測）
  - 未来7日間: `weather_data`（予測）
- **グラフ表示**:
  - 実線: 実測データ
  - 点線: 予測データ
- **日別売上表示**: 売上がない日も0として表示

#### Phase 3: 商品ランキング機能実装
- **購入数ランキング**: `receipt_items`から集計
- **売上ランキング**: 金額ベースの集計
- **リアルタイムデータ**: モックデータから実データへ移行
- **店舗別フィルタリング**: マルチテナント対応

#### Phase 4: AI Advisorマイクロサービス（ルールベース版）
- **新規サービス**: `ai-advisor` (port 8002)
- **統計分析エンジン**:
  - SalesAnalyzer: 売上トレンド分析
  - ProductAnalyzer: 商品パフォーマンス分析
  - CustomerAnalyzer: 顧客層分析
- **経営アドバイス生成**: ルールベースの推奨アクションプラン
- **Dockerイメージ**: `ai-advisor:2025-09-30-v1`
- **月額コスト**: 約¥2,000（最小構成）

**デプロイバージョン**:
- core-api: `2025-09-30-v7`
- frontend: `2025-09-30-v9`
- ai-advisor: `2025-09-30-v1`

### 2025-10-01: 改善とリファクタリング

- コード品質向上
- ドキュメント更新
- フロントエンドUI調整

### 2025-10-06: プロモーション機能実装

#### データベース変更
- **新規テーブル**: `promotions`
- **マイグレーション**: Alembic version `0b2b6cf01263`
- **主要カラム**:
  - status (draft/scheduled/active/expired/paused)
  - is_auto_published (自動掲載フラグ)
  - start_date, end_date
  - display_priority, current_views

#### バックエンドAPI
- **新規ルーター**: `routers/promotions.py`
- **エンドポイント**:
  - 事業者向け: CRUD操作、手動公開
  - ユーザー向け: `/public/active`（認証不要）
- **自動掲載バッチ**: `scripts/publish_promotions.py`

#### フロントエンド
- **事業者向けページ**: `/promotions`
  - プロモーション管理画面
  - ステータスフィルタ
  - 手動公開機能
- **ユーザー向けページ**: `/public-promotions`
  - 公開中のプロモーション一覧
  - グリッドレイアウト
  - 認証不要

#### Kubernetes CronJob
- **スケジュール**: 毎日21:00 UTC (06:00 JST)
- **処理内容**:
  - scheduled → active 自動変更
  - active → expired 自動変更
- **トラブルシューティング**:
  - Cloud SQL Proxy起動待機ロジック追加
  - Secretsパスの修正
  - スクリプトディレクトリのDockerイメージ追加

**デプロイバージョン**:
- core-api: `20251006-061220`
- frontend: `20251006-055557`

### 2025-10-10: Gemini AI統合

#### AI機能のアップグレード
- **ルールベース → LLM統合**: Gemini 2.5 Flash API
- **新規依存関係**: `google-generativeai==0.8.3`

#### 安全フィルター対策
- **問題**: `finish_reason=2` (SAFETY)エラー
- **解決策**:
  - HarmBlockThreshold.BLOCK_NONE設定
  - プロンプトの中立的表現化
  - 自然な会話形式への変更

#### レスポンスパース機能
- **キーワードベース分類**: 商品戦略/顧客戦略/天候戦略
- **リスト自動抽出**: 番号付きリスト、箇条書き対応

#### API統合
- **エンドポイント変更**: `/api/analysis/ai-advice` (GET)
- **サービス通信**: `http://ai-advisor-service:8002`
- **認証**: JWT Bearer Token

#### コスト
- **API料金**: $0.075/1M tokens (入力), $0.30/1M tokens (出力)
- **1回あたり**: 約0.04円
- **月間100店舗**: 約¥126 (1日1回 × 30日)
- **無料枠**: 1日1,500リクエストまで

**デプロイバージョン**:
- ai-advisor: `2025-10-10-v3`
- core-api: `2025-10-10-v3`
- frontend: `2025-10-10-v1`

### 2025-11-09: リポジトリクリーンアップ

- 機密情報の完全削除
- Git履歴のクリーンアップ
- 環境変数ベースへの移行
- ドキュメント整理

## 技術的な課題と解決策

### bcrypt互換性問題

**問題**: bcrypt 5.0.0とpasslib 1.7.4の非互換

**解決策**: bcrypt 4.0.1への固定化

```bash
# requirements.txt
bcrypt==4.0.1
```

### JWT秘密鍵のセキュリティ

**問題**: デフォルト秘密鍵の使用

**解決策**: 強力なランダム鍵の生成

```python
import secrets, base64
key = base64.urlsafe_b64encode(secrets.token_bytes(32)).decode()
```

### レート制限

**問題**: Redis接続エラー

**解決策**: メモリベースlimiterへのフォールバック

### Cloud SQL接続

**問題**: Cloud SQL Proxy設定

**解決策**: サイドカーコンテナパターンの採用

## セキュリティ改善履歴

### 初期状態 (Before)

- JWT有効期限: 30分
- API制限: なし
- ログ: 基本ログのみ
- パスワード制限: なし
- 秘密鍵: デフォルト値

### 強化後 (After)

- JWT有効期限: 15分 + リフレッシュトークン
- API制限: エンドポイント別に設定
- ログ: 構造化ログ + セキュリティイベント追跡
- パスワード制限: 業界標準の強度要件
- 秘密鍵: 強力なランダム値

## 今後の課題

### 技術的負債

1. Redis統合の完全実装
2. セキュリティヘッダーの追加
3. 多要素認証の検討

### 機能拡張

1. LINE連携
2. プッシュ通知
3. リアルタイム分析
4. マルチリージョン対応

## 参考リンク

- [プロジェクト概要](./PROJECT_OVERVIEW.md)
- [アーキテクチャ](./ARCHITECTURE.md)
