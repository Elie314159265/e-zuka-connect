(()=>{var e={};e.id=422,e.ids=[422],e.modules={7849:e=>{"use strict";e.exports=require("next/dist/client/components/action-async-storage.external")},2934:e=>{"use strict";e.exports=require("next/dist/client/components/action-async-storage.external.js")},5403:e=>{"use strict";e.exports=require("next/dist/client/components/request-async-storage.external")},4580:e=>{"use strict";e.exports=require("next/dist/client/components/request-async-storage.external.js")},4749:e=>{"use strict";e.exports=require("next/dist/client/components/static-generation-async-storage.external")},5869:e=>{"use strict";e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},399:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},1704:(e,t,a)=>{"use strict";a.r(t),a.d(t,{GlobalError:()=>i.a,__next_app__:()=>m,originalPathname:()=>x,pages:()=>c,routeModule:()=>u,tree:()=>d}),a(2636),a(8702),a(5866);var s=a(3191),r=a(8716),l=a(7922),i=a.n(l),n=a(5231),o={};for(let e in n)0>["default","tree","pages","GlobalError","originalPathname","__next_app__","routeModule"].indexOf(e)&&(o[e]=()=>n[e]);a.d(t,o);let d=["",{children:["mypage",{children:["__PAGE__",{},{page:[()=>Promise.resolve().then(a.bind(a,2636)),"/home/souxiasatoru/your-gcp-project-id/frontend/src/app/mypage/page.tsx"]}]},{}]},{layout:[()=>Promise.resolve().then(a.bind(a,8702)),"/home/souxiasatoru/your-gcp-project-id/frontend/src/app/layout.tsx"],"not-found":[()=>Promise.resolve().then(a.t.bind(a,5866,23)),"next/dist/client/components/not-found-error"]}],c=["/home/souxiasatoru/your-gcp-project-id/frontend/src/app/mypage/page.tsx"],x="/mypage/page",m={require:a,loadChunk:()=>Promise.resolve()},u=new s.AppPageRouteModule({definition:{kind:r.x.APP_PAGE,page:"/mypage/page",pathname:"/mypage",bundlePath:"",filename:"",appPaths:[]},userland:{loaderTree:d}})},5053:(e,t,a)=>{Promise.resolve().then(a.bind(a,823))},3255:(e,t,a)=>{"use strict";a.d(t,{Z:()=>s});let s=(0,a(2881).Z)("cloud-upload",[["path",{d:"M12 13v8",key:"1l5pq0"}],["path",{d:"M4 14.899A7 7 0 1 1 15.71 8h1.79a4.5 4.5 0 0 1 2.5 8.242",key:"1pljnt"}],["path",{d:"m8 17 4-4 4 4",key:"1quai1"}]])},5047:(e,t,a)=>{"use strict";var s=a(7389);a.o(s,"useRouter")&&a.d(t,{useRouter:function(){return s.useRouter}})},823:(e,t,a)=>{"use strict";a.r(t),a.d(t,{default:()=>f});var s=a(326),r=a(7577),l=a(6854),i=a(434),n=a(3255),o=a(2881);let d=(0,o.Z)("award",[["path",{d:"m15.477 12.89 1.515 8.526a.5.5 0 0 1-.81.47l-3.58-2.687a1 1 0 0 0-1.197 0l-3.586 2.686a.5.5 0 0 1-.81-.469l1.514-8.526",key:"1yiouv"}],["circle",{cx:"12",cy:"8",r:"6",key:"1vp47v"}]]),c=(0,o.Z)("lock",[["rect",{width:"18",height:"11",x:"3",y:"11",rx:"2",ry:"2",key:"1w4ew1"}],["path",{d:"M7 11V7a5 5 0 0 1 10 0v4",key:"fwvmzm"}]]),x=(0,o.Z)("star",[["path",{d:"M11.525 2.295a.53.53 0 0 1 .95 0l2.31 4.679a2.123 2.123 0 0 0 1.595 1.16l5.166.756a.53.53 0 0 1 .294.904l-3.736 3.638a2.123 2.123 0 0 0-.611 1.878l.882 5.14a.53.53 0 0 1-.771.56l-4.618-2.428a2.122 2.122 0 0 0-1.973 0L6.396 21.01a.53.53 0 0 1-.77-.56l.881-5.139a2.122 2.122 0 0 0-.611-1.879L2.16 9.795a.53.53 0 0 1 .294-.906l5.165-.755a2.122 2.122 0 0 0 1.597-1.16z",key:"r04s7s"}]]),m=(0,o.Z)("gift",[["rect",{x:"3",y:"8",width:"18",height:"4",rx:"1",key:"bkv52"}],["path",{d:"M12 8v13",key:"1c76mn"}],["path",{d:"M19 12v7a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2v-7",key:"6wjy6b"}],["path",{d:"M7.5 8a2.5 2.5 0 0 1 0-5A4.8 8 0 0 1 12 8a4.8 8 0 0 1 4.5-5 2.5 2.5 0 0 1 0 5",key:"1ihvrl"}]]);var u=a(4727),p=a(5047);let h={initial:{opacity:0,y:20},in:{opacity:1,y:0},out:{opacity:0,y:-20}},g={type:"tween",ease:"anticipate",duration:.5};function f(){let[e,t]=(0,r.useState)(null),[a,o]=(0,r.useState)(null),[f,b]=(0,r.useState)("idle"),[y,j]=(0,r.useState)(""),[v,w]=(0,r.useState)(null),[N,_]=(0,r.useState)([]),[k,$]=(0,r.useState)([]),[P,q]=(0,r.useState)(!0),{token:S,isLoggedIn:M}=(0,u.t)(),z=(0,p.useRouter)(),A=async()=>{if(!S)return;let e="http://localhost:8000";try{q(!0);let t=await fetch(`${e}/api/gamification/profile`,{headers:{Authorization:`Bearer ${S}`}});if(t.ok){let e=await t.json();w(e)}let a=await fetch(`${e}/api/gamification/badges`,{headers:{Authorization:`Bearer ${S}`}});if(a.ok){let e=await a.json();_(e)}let s=await fetch(`${e}/api/gamification/rewards`);if(s.ok){let e=await s.json();$(e)}}catch(e){console.error("Failed to fetch gamification data:",e)}finally{q(!1)}},E=async a=>{if(a.preventDefault(),!e){j("ファイルを選択してください。"),b("error");return}if(!S){j("認証トークンがありません。再度ログインしてください。"),b("error");return}b("uploading"),j("アップロード中...");let s=new FormData;s.append("file",e);try{let e=await fetch("http://localhost:8000/api/receipts/upload",{method:"POST",headers:{Authorization:`Bearer ${S}`},body:s});if(401===e.status){j("認証の有効期限が切れました。再度ログインしてください。"),b("error"),u.t.getState().setToken(null),z.push("/login/user");return}let a=await e.json();if(e.ok){b("success");let e=a.receipt?.supplier_name||"店舗名不明",s=a.receipt?.total_amount||"金額不明",r=a.points_earned||0,l=a.badges_awarded||[],i=`アップロード成功！ ${e} で ${s} 円分の貢献を記録しました！`;r>0&&(i+=` ${r}ポイント獲得！`),l.length>0&&(i+=` 新しいバッジを獲得: ${l.map(e=>e.badge_name).join(", ")}`),j(i),setTimeout(()=>{A(),t(null),o(null)},1e3)}else b("error"),j(`アップロード失敗: ${a.detail||"不明なエラーが発生しました。"}`)}catch(e){b("error"),j(`クライアントサイドエラー: ${e instanceof Error?e.message:String(e)}`)}},R=async e=>{if(S&&window.confirm("この特典を交換しますか？"))try{let t=await fetch("http://localhost:8000/api/gamification/redeem",{method:"POST",headers:{Authorization:`Bearer ${S}`,"Content-Type":"application/json"},body:JSON.stringify({reward_id:e})}),a=await t.json();t.ok?(alert(`特典交換完了！クーポンコード: ${a.coupon_code}
有効期限: ${new Date(a.expires_at).toLocaleDateString()}`),A()):alert(`交換に失敗しました: ${a.detail}`)}catch(e){alert("交換中にエラーが発生しました")}};return s.jsx(l.E.div,{className:"min-h-screen bg-gray-100 py-24",initial:"initial",animate:"in",exit:"out",variants:h,transition:g,children:(0,s.jsxs)("div",{className:"container mx-auto px-6",children:[(0,s.jsxs)("div",{className:"flex justify-between items-center mb-8",children:[s.jsx("h1",{className:"text-4xl font-bold",children:"マイページ"}),s.jsx(i.default,{href:"/",className:"text-sm text-gray-500 hover:text-gray-700",children:"トップページに戻る"})]}),(0,s.jsxs)("div",{className:"bg-white p-8 rounded-xl shadow-md text-center mb-8",children:[s.jsx("p",{className:"text-gray-500",children:"現在の貢献ポイント"}),P?(0,s.jsxs)("div",{className:"animate-pulse",children:[s.jsx("div",{className:"h-16 bg-gray-200 rounded my-2"}),s.jsx("div",{className:"h-4 bg-gray-200 rounded"})]}):(0,s.jsxs)(s.Fragment,{children:[(0,s.jsxs)("p",{className:"text-5xl font-bold text-blue-600 my-2",children:[v?.contribution_points||0," ",s.jsx("span",{className:"text-2xl",children:"pt"})]}),(0,s.jsxs)("p",{className:"text-gray-600",children:["レベル ",v?.level||1," | 総獲得ポイント ",v?.total_earned_points||0," pt"]}),k.length>0&&v&&(()=>{let e=k.filter(e=>e.required_points>v.contribution_points);if(e.length>0){let t=Math.min(...e.map(e=>e.required_points-v.contribution_points));return(0,s.jsxs)("p",{className:"text-gray-600 mt-2",children:["次の特典まであと"," ",(0,s.jsxs)("span",{className:"font-bold",children:[t," pt"]})]})}return null})()]})]}),(0,s.jsxs)("div",{className:"bg-white p-6 rounded-xl shadow-md mb-8",children:[s.jsx("h3",{className:"font-bold text-xl mb-4",children:"レシートを投稿して貢献！"}),s.jsx("form",{onSubmit:E,children:(0,s.jsxs)("div",{className:"flex flex-col sm:flex-row items-center sm:space-x-4",children:[s.jsx("input",{type:"file",onChange:e=>{if(e.target.files&&e.target.files[0]){let a=e.target.files[0];t(a),o(URL.createObjectURL(a)),b("idle"),j("")}},className:"block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-violet-50 file:text-violet-700 hover:file:bg-violet-100 mb-4 sm:mb-0",accept:"image/png, image/jpeg, image/jpg"}),(0,s.jsxs)(l.E.button,{type:"submit",disabled:!e||"uploading"===f,whileHover:{scale:1.05},whileTap:{scale:.95},className:"w-full sm:w-auto flex items-center justify-center px-6 py-3 bg-blue-500 hover:bg-blue-600 text-white font-bold rounded-full disabled:bg-gray-400 transition-colors",children:[s.jsx(n.Z,{className:"w-5 h-5 mr-2"}),"uploading"===f?"処理中...":"投稿する"]})]})}),a&&(0,s.jsxs)("div",{className:"mt-4",children:[s.jsx("p",{className:"text-sm text-gray-600",children:"プレビュー:"}),s.jsx("img",{src:a,alt:"選択された画像のプレビュー",className:"mt-2 max-h-48 rounded-lg shadow-md border"})]}),y&&s.jsx("div",{className:`mt-4 p-4 rounded-lg text-sm ${"success"===f?"bg-green-100 text-green-800":""} ${"error"===f?"bg-red-100 text-red-800":""} ${"uploading"===f?"bg-blue-100 text-blue-800":""}`,children:s.jsx("p",{children:y})})]}),(0,s.jsxs)("div",{className:"grid md:grid-cols-2 gap-8",children:[(0,s.jsxs)("div",{className:"bg-white p-6 rounded-xl shadow-md",children:[s.jsx("h3",{className:"font-bold text-xl mb-4",children:"獲得したバッジ"}),P?s.jsx("div",{className:"flex flex-wrap gap-4",children:[void 0,void 0,void 0,void 0].map((e,t)=>(0,s.jsxs)("div",{className:"animate-pulse",children:[s.jsx("div",{className:"w-16 h-16 bg-gray-200 rounded-full mb-1"}),s.jsx("div",{className:"w-12 h-3 bg-gray-200 rounded"})]},t))}):s.jsx("div",{className:"flex flex-wrap gap-4",children:N.length>0?N.map(e=>(0,s.jsxs)("div",{className:"text-center",title:e.badge.description,children:[e.badge.icon_url?s.jsx("img",{src:e.badge.icon_url,alt:e.badge.name,className:"w-16 h-16 mx-auto"}):s.jsx(d,{className:"w-16 h-16 text-yellow-500 mx-auto"}),s.jsx("span",{className:"text-xs text-gray-500 block mt-1",children:e.badge.name})]},e.id)):(0,s.jsxs)("div",{className:"text-center text-gray-500 w-full",children:[s.jsx(c,{className:"w-16 h-16 text-gray-300 mx-auto mb-2"}),s.jsx("p",{children:"まだバッジを獲得していません"}),s.jsx("p",{className:"text-sm",children:"レシートをアップロードしてバッジを獲得しよう！"})]})})]}),(0,s.jsxs)("div",{className:"bg-white p-6 rounded-xl shadow-md",children:[s.jsx("h3",{className:"font-bold text-xl mb-4",children:"交換できる特典"}),P?s.jsx("ul",{className:"space-y-3",children:[void 0,void 0,void 0].map((e,t)=>s.jsx("li",{className:"animate-pulse",children:(0,s.jsxs)("div",{className:"flex justify-between items-center p-3 bg-gray-50 rounded-lg",children:[s.jsx("div",{className:"h-4 bg-gray-200 rounded w-32"}),s.jsx("div",{className:"h-4 bg-gray-200 rounded w-16"})]})},t))}):s.jsx("ul",{className:"space-y-3",children:k.length>0?k.map(e=>{let t=v&&v.contribution_points>=e.required_points,a=null!==e.available_stock&&e.available_stock<=0;return(0,s.jsxs)("li",{className:`flex justify-between items-center p-3 rounded-lg ${t&&!a?"bg-green-50 border border-green-200":a?"bg-red-50 border border-red-200 text-red-600":"bg-gray-50"}`,children:[(0,s.jsxs)("div",{className:"flex-1",children:[s.jsx("span",{className:"block font-medium",children:e.title}),s.jsx("span",{className:"text-sm text-gray-600",children:e.description}),null!==e.available_stock&&(0,s.jsxs)("span",{className:"text-xs text-gray-500 block",children:["在庫: ",e.available_stock,"個"]})]}),(0,s.jsxs)("div",{className:"flex items-center space-x-2",children:[e.is_featured&&s.jsx(x,{className:"w-4 h-4 text-yellow-500"}),(0,s.jsxs)("span",{className:`font-bold ${t&&!a?"text-green-600":"text-blue-600"}`,children:[e.required_points," pt"]}),t&&!a&&s.jsx("button",{className:"ml-2 px-3 py-1 bg-blue-500 text-white text-xs rounded-full hover:bg-blue-600 transition-colors",onClick:()=>R(e.id),children:"交換"})]})]},e.id)}):(0,s.jsxs)("li",{className:"text-center text-gray-500 py-8",children:[s.jsx(m,{className:"w-16 h-16 text-gray-300 mx-auto mb-2"}),s.jsx("p",{children:"現在利用可能な特典がありません"})]})})]})]})]})})}},2636:(e,t,a)=>{"use strict";a.r(t),a.d(t,{$$typeof:()=>i,__esModule:()=>l,default:()=>n});var s=a(8570);let r=(0,s.createProxy)(String.raw`/home/souxiasatoru/your-gcp-project-id/frontend/src/app/mypage/page.tsx`),{__esModule:l,$$typeof:i}=r;r.default;let n=(0,s.createProxy)(String.raw`/home/souxiasatoru/your-gcp-project-id/frontend/src/app/mypage/page.tsx#default`)}};var t=require("../../webpack-runtime.js");t.C(e);var a=e=>t(t.s=e),s=t.X(0,[573,853],()=>a(1704));module.exports=s})();