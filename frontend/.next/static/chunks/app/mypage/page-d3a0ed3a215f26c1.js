(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[422],{1820:function(e,t,a){Promise.resolve().then(a.bind(a,9357))},9357:function(e,t,a){"use strict";a.r(t),a.d(t,{default:function(){return g}});var s=a(7437),l=a(2265),i=a(6349),n=a(7138),r=a(2584),c=a(8281),o=a(4453),d=a(9338),m=a(6997),x=a(8320),u=a(6463);let h={initial:{opacity:0,y:20},in:{opacity:1,y:0},out:{opacity:0,y:-20}},p={type:"tween",ease:"anticipate",duration:.5};function g(){let[e,t]=(0,l.useState)(null),[a,g]=(0,l.useState)(null),[f,b]=(0,l.useState)("idle"),[j,N]=(0,l.useState)(""),[v,y]=(0,l.useState)(null),[w,_]=(0,l.useState)([]),[k,S]=(0,l.useState)([]),[E,T]=(0,l.useState)(!0),{token:O,isLoggedIn:C}=(0,x.t)(),L=(0,u.useRouter)();(0,l.useEffect)(()=>{if(!C()){L.push("/login/user");return}Z()},[C,L,O]);let Z=async()=>{if(!O)return;let e="http://localhost:8000";try{T(!0);let t=await fetch("".concat(e,"/api/gamification/profile"),{headers:{Authorization:"Bearer ".concat(O)}});if(t.ok){let e=await t.json();y(e)}let a=await fetch("".concat(e,"/api/gamification/badges"),{headers:{Authorization:"Bearer ".concat(O)}});if(a.ok){let e=await a.json();_(e)}let s=await fetch("".concat(e,"/api/gamification/rewards"));if(s.ok){let e=await s.json();S(e)}}catch(e){console.error("Failed to fetch gamification data:",e)}finally{T(!1)}},q=async a=>{if(a.preventDefault(),!e){N("ファイルを選択してください。"),b("error");return}if(!O){N("認証トークンがありません。再度ログインしてください。"),b("error");return}b("uploading"),N("アップロード中...");let s=new FormData;s.append("file",e);try{let e=await fetch("".concat("http://localhost:8000","/api/receipts/upload"),{method:"POST",headers:{Authorization:"Bearer ".concat(O)},body:s});if(401===e.status){N("認証の有効期限が切れました。再度ログインしてください。"),b("error"),x.t.getState().setToken(null),L.push("/login/user");return}let a=await e.json();if(e.ok){var l,i;b("success");let e=(null===(l=a.receipt)||void 0===l?void 0:l.supplier_name)||"店舗名不明",s=(null===(i=a.receipt)||void 0===i?void 0:i.total_amount)||"金額不明",n=a.points_earned||0,r=a.badges_awarded||[],c="アップロード成功！ ".concat(e," で ").concat(s," 円分の貢献を記録しました！");n>0&&(c+=" ".concat(n,"ポイント獲得！")),r.length>0&&(c+=" 新しいバッジを獲得: ".concat(r.map(e=>e.badge_name).join(", "))),N(c),setTimeout(()=>{Z(),t(null),g(null)},1e3)}else b("error"),N("アップロード失敗: ".concat(a.detail||"不明なエラーが発生しました。"))}catch(e){b("error"),N("クライアントサイドエラー: ".concat(e instanceof Error?e.message:String(e)))}},z=async e=>{if(O&&window.confirm("この特典を交換しますか？"))try{let t=await fetch("".concat("http://localhost:8000","/api/gamification/redeem"),{method:"POST",headers:{Authorization:"Bearer ".concat(O),"Content-Type":"application/json"},body:JSON.stringify({reward_id:e})}),a=await t.json();t.ok?(alert("特典交換完了！クーポンコード: ".concat(a.coupon_code,"\n有効期限: ").concat(new Date(a.expires_at).toLocaleDateString())),Z()):alert("交換に失敗しました: ".concat(a.detail))}catch(e){alert("交換中にエラーが発生しました")}};return(0,s.jsx)(i.E.div,{className:"min-h-screen bg-gray-100 py-24",initial:"initial",animate:"in",exit:"out",variants:h,transition:p,children:(0,s.jsxs)("div",{className:"container mx-auto px-6",children:[(0,s.jsxs)("div",{className:"flex justify-between items-center mb-8",children:[(0,s.jsx)("h1",{className:"text-4xl font-bold",children:"マイページ"}),(0,s.jsx)(n.default,{href:"/",className:"text-sm text-gray-500 hover:text-gray-700",children:"トップページに戻る"})]}),(0,s.jsxs)("div",{className:"bg-white p-8 rounded-xl shadow-md text-center mb-8",children:[(0,s.jsx)("p",{className:"text-gray-500",children:"現在の貢献ポイント"}),E?(0,s.jsxs)("div",{className:"animate-pulse",children:[(0,s.jsx)("div",{className:"h-16 bg-gray-200 rounded my-2"}),(0,s.jsx)("div",{className:"h-4 bg-gray-200 rounded"})]}):(0,s.jsxs)(s.Fragment,{children:[(0,s.jsxs)("p",{className:"text-5xl font-bold text-blue-600 my-2",children:[(null==v?void 0:v.contribution_points)||0," ",(0,s.jsx)("span",{className:"text-2xl",children:"pt"})]}),(0,s.jsxs)("p",{className:"text-gray-600",children:["レベル ",(null==v?void 0:v.level)||1," | 総獲得ポイント ",(null==v?void 0:v.total_earned_points)||0," pt"]}),k.length>0&&v&&(()=>{let e=k.filter(e=>e.required_points>v.contribution_points);if(e.length>0){let t=Math.min(...e.map(e=>e.required_points-v.contribution_points));return(0,s.jsxs)("p",{className:"text-gray-600 mt-2",children:["次の特典まであと"," ",(0,s.jsxs)("span",{className:"font-bold",children:[t," pt"]})]})}return null})()]})]}),(0,s.jsxs)("div",{className:"bg-white p-6 rounded-xl shadow-md mb-8",children:[(0,s.jsx)("h3",{className:"font-bold text-xl mb-4",children:"レシートを投稿して貢献！"}),(0,s.jsx)("form",{onSubmit:q,children:(0,s.jsxs)("div",{className:"flex flex-col sm:flex-row items-center sm:space-x-4",children:[(0,s.jsx)("input",{type:"file",onChange:e=>{if(e.target.files&&e.target.files[0]){let a=e.target.files[0];t(a),g(URL.createObjectURL(a)),b("idle"),N("")}},className:"block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-violet-50 file:text-violet-700 hover:file:bg-violet-100 mb-4 sm:mb-0",accept:"image/png, image/jpeg, image/jpg"}),(0,s.jsxs)(i.E.button,{type:"submit",disabled:!e||"uploading"===f,whileHover:{scale:1.05},whileTap:{scale:.95},className:"w-full sm:w-auto flex items-center justify-center px-6 py-3 bg-blue-500 hover:bg-blue-600 text-white font-bold rounded-full disabled:bg-gray-400 transition-colors",children:[(0,s.jsx)(r.Z,{className:"w-5 h-5 mr-2"}),"uploading"===f?"処理中...":"投稿する"]})]})}),a&&(0,s.jsxs)("div",{className:"mt-4",children:[(0,s.jsx)("p",{className:"text-sm text-gray-600",children:"プレビュー:"}),(0,s.jsx)("img",{src:a,alt:"選択された画像のプレビュー",className:"mt-2 max-h-48 rounded-lg shadow-md border"})]}),j&&(0,s.jsx)("div",{className:"mt-4 p-4 rounded-lg text-sm ".concat("success"===f?"bg-green-100 text-green-800":""," ").concat("error"===f?"bg-red-100 text-red-800":""," ").concat("uploading"===f?"bg-blue-100 text-blue-800":""),children:(0,s.jsx)("p",{children:j})})]}),(0,s.jsxs)("div",{className:"grid md:grid-cols-2 gap-8",children:[(0,s.jsxs)("div",{className:"bg-white p-6 rounded-xl shadow-md",children:[(0,s.jsx)("h3",{className:"font-bold text-xl mb-4",children:"獲得したバッジ"}),E?(0,s.jsx)("div",{className:"flex flex-wrap gap-4",children:[void 0,void 0,void 0,void 0].map((e,t)=>(0,s.jsxs)("div",{className:"animate-pulse",children:[(0,s.jsx)("div",{className:"w-16 h-16 bg-gray-200 rounded-full mb-1"}),(0,s.jsx)("div",{className:"w-12 h-3 bg-gray-200 rounded"})]},t))}):(0,s.jsx)("div",{className:"flex flex-wrap gap-4",children:w.length>0?w.map(e=>(0,s.jsxs)("div",{className:"text-center",title:e.badge.description,children:[e.badge.icon_url?(0,s.jsx)("img",{src:e.badge.icon_url,alt:e.badge.name,className:"w-16 h-16 mx-auto"}):(0,s.jsx)(c.Z,{className:"w-16 h-16 text-yellow-500 mx-auto"}),(0,s.jsx)("span",{className:"text-xs text-gray-500 block mt-1",children:e.badge.name})]},e.id)):(0,s.jsxs)("div",{className:"text-center text-gray-500 w-full",children:[(0,s.jsx)(o.Z,{className:"w-16 h-16 text-gray-300 mx-auto mb-2"}),(0,s.jsx)("p",{children:"まだバッジを獲得していません"}),(0,s.jsx)("p",{className:"text-sm",children:"レシートをアップロードしてバッジを獲得しよう！"})]})})]}),(0,s.jsxs)("div",{className:"bg-white p-6 rounded-xl shadow-md",children:[(0,s.jsx)("h3",{className:"font-bold text-xl mb-4",children:"交換できる特典"}),E?(0,s.jsx)("ul",{className:"space-y-3",children:[void 0,void 0,void 0].map((e,t)=>(0,s.jsx)("li",{className:"animate-pulse",children:(0,s.jsxs)("div",{className:"flex justify-between items-center p-3 bg-gray-50 rounded-lg",children:[(0,s.jsx)("div",{className:"h-4 bg-gray-200 rounded w-32"}),(0,s.jsx)("div",{className:"h-4 bg-gray-200 rounded w-16"})]})},t))}):(0,s.jsx)("ul",{className:"space-y-3",children:k.length>0?k.map(e=>{let t=v&&v.contribution_points>=e.required_points,a=null!==e.available_stock&&e.available_stock<=0;return(0,s.jsxs)("li",{className:"flex justify-between items-center p-3 rounded-lg ".concat(t&&!a?"bg-green-50 border border-green-200":a?"bg-red-50 border border-red-200 text-red-600":"bg-gray-50"),children:[(0,s.jsxs)("div",{className:"flex-1",children:[(0,s.jsx)("span",{className:"block font-medium",children:e.title}),(0,s.jsx)("span",{className:"text-sm text-gray-600",children:e.description}),null!==e.available_stock&&(0,s.jsxs)("span",{className:"text-xs text-gray-500 block",children:["在庫: ",e.available_stock,"個"]})]}),(0,s.jsxs)("div",{className:"flex items-center space-x-2",children:[e.is_featured&&(0,s.jsx)(d.Z,{className:"w-4 h-4 text-yellow-500"}),(0,s.jsxs)("span",{className:"font-bold ".concat(t&&!a?"text-green-600":"text-blue-600"),children:[e.required_points," pt"]}),t&&!a&&(0,s.jsx)("button",{className:"ml-2 px-3 py-1 bg-blue-500 text-white text-xs rounded-full hover:bg-blue-600 transition-colors",onClick:()=>z(e.id),children:"交換"})]})]},e.id)}):(0,s.jsxs)("li",{className:"text-center text-gray-500 py-8",children:[(0,s.jsx)(m.Z,{className:"w-16 h-16 text-gray-300 mx-auto mb-2"}),(0,s.jsx)("p",{children:"現在利用可能な特典がありません"})]})})]})]})]})})}},8320:function(e,t,a){"use strict";a.d(t,{t:function(){return i}});var s=a(903),l=a(9291);let i=(0,s.U)()((0,l.tJ)((e,t)=>({token:null,setToken:t=>e({token:t}),isLoggedIn:()=>!!t().token}),{name:"auth-storage",storage:(0,l.FL)(()=>sessionStorage)}))}},function(e){e.O(0,[349,138,436,971,23,744],function(){return e(e.s=1820)}),_N_E=e.O()}]);